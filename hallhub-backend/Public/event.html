<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Submit Hall Event</title>
  <style>
    body {
      background: linear-gradient(to right, #ffecd2, #fcb69f);
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      min-height: 100vh;
    }
    .header { padding: 20px; font-size: 2rem; font-weight: bold; }
    .form-box {
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(8px);
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .form-box h2 { text-align: center; margin-bottom: 20px; }
    input, textarea, select {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.7);
      font-size: 1rem;
      box-sizing: border-box;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 10px rgba(255, 110, 196, 0.3);
    }

    input[readonly] {
      background-color: #f8f9fa !important;
      color: #6c757d !important;
      cursor: not-allowed;
      border-color: #e9ecef !important;
    }

    textarea { resize: vertical; height: 80px; }
    button {
      background: #ff6ec4;
      color: white;
      padding: 12px 25px;
      margin-top: 15px;
      border: none;
      border-radius: 30px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
    }
    button:hover { background: #fc5c7d; transform: scale(1.05); }
    button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .event-display { padding: 15px; border-radius: 16px; margin: 10px 0; }
    .success-message { border-left: 6px solid #27ae60; background: rgba(39, 174, 96, 0.1); color: #27ae60; }
    .error-message { border-left: 6px solid #e74c3c; background: rgba(231, 76, 60, 0.1); color: #e74c3c; }
    .loading-message { border-left: 6px solid #f39c12; background: rgba(243, 156, 18, 0.1); color: #f39c12; }
    .back-link { margin-top: 30px; text-align: center; }
    .back-link a { text-decoration: none; color: #0056b3; font-weight: bold; padding: 10px 20px; border-radius: 20px; background: rgba(255, 255, 255, 0.3); transition: all 0.3s ease; }
    .back-link a:hover { background: rgba(255, 255, 255, 0.6); }
    .events-list { background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(8px); padding: 30px; border-radius: 20px; width: 90%; max-width: 800px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); margin-top: 30px; }
    .event-card { 
      background: rgba(255, 255, 255, 0.7); 
      padding: 15px; 
      margin: 10px 0; 
      border-radius: 12px; 
      position: relative;
    }
    .event-card.approved { border-left: 4px solid #27ae60; }
    .event-card.pending { border-left: 4px solid #f39c12; }
    .event-card h4 { margin: 0 0 10px 0; color: #333; }
    .event-card p { margin: 5px 0; color: #666; font-size: 0.9rem; }
    .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    .status-badge.approved {
      background: rgba(39, 174, 96, 0.2);
      color: #27ae60;
    }
    .status-badge.pending {
      background: rgba(243, 156, 18, 0.2);
      color: #f39c12;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
    }
    .tab-button {
      padding: 10px 20px;
      border: none;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.3);
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      width: auto;
      margin: 0;
    }
    .tab-button.active {
      background: #ff6ec4;
      color: white;
    }
    .tab-button:hover:not(.active) {
      background: rgba(255, 255, 255, 0.5);
    }
  </style>
</head>
<body>
  <div class="header">üìÖ Submit a Hall Event</div>

  <div class="form-box">
    <h2>Event Info</h2>
    <form id="eventForm">
      <input type="text" id="eventTitle" placeholder="Event Title (e.g. Cultural Fest)" required />

      <!-- Event Type Dropdown (after Title) -->
      <select id="eventType" required>
        <option value="">Select Event Type</option>
        <option value="Cultural">Cultural</option>
        <option value="Sports">Sports</option>
        <option value="Food">Food</option>
        <option value="Religious">Religious</option>
        <option value="Meeting">Meeting</option>
      </select>

      <input type="date" id="eventDate" required />
      <input type="time" id="eventTime" placeholder="Event Time (optional)" />
      <textarea id="eventDesc" placeholder="Event Description" required></textarea>
      <input type="text" id="organizerId" placeholder="Your Student ID" required />
      <button type="submit" id="submitBtn">üöÄ Submit Event</button>
    </form>
  </div>

  <div id="eventMessage"></div>

  <div class="events-list" id="eventsList">
    <div class="tabs">
      <button class="tab-button active" id="allEventsTab">üìã All Events</button>
      <button class="tab-button" id="myEventsTab">üë§ My Events</button>
    </div>
    <div id="eventsContainer"><p>Loading events...</p></div>
  </div>

  <div class="back-link">
    <a href="dashb.html">‚Üê Back to Dashboard</a>
  </div>

  <script>
// Session helper functions
function getCurrentUser() {
  try {
    const userSession = localStorage.getItem('userSession') || sessionStorage.getItem('userSession');
    return userSession ? JSON.parse(userSession) : null;
  } catch (error) {
    console.error('Error parsing user session:', error);
    return null;
  }
}

function initializeStudentIdField() {
  const currentUser = getCurrentUser();
  const studentIdField = document.getElementById('organizerId');
  
  if (!currentUser || !currentUser.studentId) {
    alert('Please log in to submit events');
    window.location.href = 'login.html';
    return null;
  }
  
  if (studentIdField) {
    studentIdField.value = currentUser.studentId;
    studentIdField.readOnly = true;
  }
  
  return currentUser;
}

let currentView = 'all'; // 'all' or 'my'
let currentUser = null;

document.addEventListener('DOMContentLoaded', function() {
  currentUser = initializeStudentIdField();
  if (currentUser) {
    console.log('Logged in as:', currentUser.name, '(ID:', currentUser.studentId + ')');
  }
  
  // Set minimum date to today
  document.getElementById('eventDate').min = new Date().toISOString().split('T')[0];
  
  // Load events based on current view
  loadEvents();
  
  // Tab event listeners
  document.getElementById('allEventsTab').addEventListener('click', () => switchTab('all'));
  document.getElementById('myEventsTab').addEventListener('click', () => switchTab('my'));
});

function switchTab(view) {
  currentView = view;
  
  // Update tab appearance
  document.querySelectorAll('.tab-button').forEach(tab => tab.classList.remove('active'));
  document.getElementById(view === 'all' ? 'allEventsTab' : 'myEventsTab').classList.add('active');
  
  // Load events for the selected view
  loadEvents();
}

document.getElementById("eventForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';
  showMessage('Submitting your event...', 'loading');

  const Title = document.getElementById("eventTitle").value.trim();
  const Type = document.getElementById("eventType").value;
  const DateVal = document.getElementById("eventDate").value;
  const TimeVal = document.getElementById("eventTime").value;
  const Description = document.getElementById("eventDesc").value.trim();
  const Student_ID = document.getElementById("organizerId").value.trim();

  // Validation
  if (!Title || !Type || !DateVal || !Student_ID || !Description) {
    showMessage('‚ùå Please fill in all required fields.', 'error');
    submitBtn.disabled = false;
    submitBtn.textContent = 'üöÄ Submit Event';
    return;
  }

  // Format datetime
  const DateTime = TimeVal ? `${DateVal} ${TimeVal}:00` : `${DateVal} 12:00:00`;

  try {
    const response = await fetch('http://localhost:3000/api/events', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ 
        Title, 
        Type, 
        Date: DateTime, 
        Description, 
        Student_ID: parseInt(Student_ID) // Ensure it's a number
      })
    });

    const responseText = await response.text();
    console.log('Server response:', responseText);
    
    let result;
    try {
      result = JSON.parse(responseText);
    } catch (parseError) {
      console.error('Failed to parse response:', parseError);
      result = { error: 'Invalid server response: ' + responseText };
    }

    if (response.ok && result.success) {
      showMessage(`<h3>üéâ Event Submitted Successfully!</h3>
        <p><strong>Title:</strong> ${Title}</p>
        <p><strong>Type:</strong> ${Type}</p>
        <p><strong>Date:</strong> ${new Date(DateTime).toLocaleDateString()}</p>
        <p><strong>Time:</strong> ${new Date(DateTime).toLocaleTimeString()}</p>
        <p><strong>Organizer:</strong> ${Student_ID}</p>
        <p><strong>Event ID:</strong> #${result.Event_ID}</p>
        <p><strong>Status:</strong> ${result.Status || 'Pending Approval'}</p>
        <p><em>Your event has been submitted and is pending approval.</em></p>`, 'success');

      // Reset form but keep student ID
      document.getElementById("eventForm").reset();
      document.getElementById('organizerId').value = Student_ID;
      document.getElementById('organizerId').readOnly = true;
      
      // Reload events list
      setTimeout(() => {
        loadEvents();
      }, 1000); // Small delay to ensure database is updated
      
    } else {
      const errorMessage = result.error || result.message || 'Unknown error occurred';
      showMessage(`‚ùå Error: ${errorMessage}`, 'error');
    }
    
  } catch (error) {
    console.error('Network error:', error);
    showMessage(`‚ùå Connection failed: ${error.message}`, 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'üöÄ Submit Event';
  }
});

function showMessage(message, type) {
  const msgDiv = document.getElementById('eventMessage');
  const box = document.createElement('div');
  box.className = `event-display ${type}-message`;
  box.innerHTML = message;
  msgDiv.innerHTML = '';
  msgDiv.appendChild(box);
  
  // Auto-hide success messages after 7 seconds
  if (type === 'success') {
    setTimeout(() => {
      msgDiv.innerHTML = '';
    }, 7000);
  }
}

async function loadEvents() {
  const container = document.getElementById('eventsContainer');
  container.innerHTML = '<p>Loading events...</p>';
  
  try {
    let url = 'http://localhost:3000/api/events';
    
    if (currentView === 'all' && currentUser) {
      // For "All Events" tab: show approved events + user's pending events
      url += `?student_id=${currentUser.studentId}`;
    } else if (currentView === 'my' && currentUser) {
      // For "My Events" tab: show only user's events (all statuses)
      url = `http://localhost:3000/api/events/my/${currentUser.studentId}`;
    }
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const events = await response.json();
    console.log('Loaded events:', events);
    
    if (!events || !Array.isArray(events) || events.length === 0) {
      const emptyMessage = currentView === 'my' ? 'You have not submitted any events yet.' : 'No events found.';
      container.innerHTML = `<p>${emptyMessage}</p>`;
      return;
    }
    
    let html = '';
    events.forEach(event => {
      try {
        const eventDate = new Date(event.Date);
        const isValidDate = !isNaN(eventDate.getTime());
        const statusClass = event.Status === 1 ? 'approved' : 'pending';
        const statusText = event.StatusText || (event.Status === 1 ? 'Approved' : 'Pending');
        const isOwnEvent = currentUser && event.Student_ID == currentUser.studentId;
        
        html += `<div class="event-card ${statusClass}">
          <div class="status-badge ${statusClass}">${statusText}</div>
          <h4>${event.Title || 'Untitled Event'}</h4>
          <p><strong>Type:</strong> ${event.Type || 'Not specified'}</p>
          <p><strong>üìÖ Date:</strong> ${isValidDate ? eventDate.toLocaleDateString() : 'Invalid date'}</p>
          <p><strong>üïí Time:</strong> ${isValidDate ? eventDate.toLocaleTimeString() : 'Invalid time'}</p>
          ${event.Description ? `<p><strong>üìù Description:</strong> ${event.Description}</p>` : ''}
          <p><strong>üë§ Organizer ID:</strong> ${event.Student_ID || 'Unknown'}${isOwnEvent ? ' (You)' : ''}</p>
          <p><strong>Event ID:</strong> #${event.Event_ID || 'Unknown'}</p>
        </div>`;
      } catch (eventError) {
        console.error('Error processing event:', event, eventError);
      }
    });
    
    container.innerHTML = html || '<p>No valid events to display.</p>';
    
  } catch (error) {
    console.error('Error loading events:', error);
    container.innerHTML = `<p class="error-message">Failed to load events: ${error.message}</p>`;
  }
}
  </script>
</body>
</html>