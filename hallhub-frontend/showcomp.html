<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <title>Show My Complaints</title>
 <style>
   body {
     background: linear-gradient(to right, #c2e9fb, #a1c4fd);
     font-family: 'Segoe UI', sans-serif;
     margin: 0;
     padding: 0;
     display: flex;
     flex-direction: column;
     align-items: center;
     min-height: 100vh;
     color: #333;
   }

   .header {
     font-size: 2rem;
     font-weight: bold;
     padding: 20px;
     text-align: center;
   }

   .auto-load-container {
     background: rgba(255,255,255,0.6);
     backdrop-filter: blur(8px);
     padding: 25px;
     border-radius: 20px;
     width: 90%;
     max-width: 600px;
     box-shadow: 0 8px 24px rgba(0,0,0,0.1);
     margin-bottom: 20px;
     text-align: center;
   }

   .student-info {
     background: rgba(106, 130, 251, 0.1);
     padding: 15px;
     border-radius: 12px;
     margin-bottom: 20px;
     border-left: 4px solid #6a82fb;
   }

   /* DEBUG STYLES - COMMENTED OUT
   .debug-info {
     background: rgba(255, 193, 7, 0.1);
     padding: 15px;
     border-radius: 12px;
     margin-bottom: 20px;
     border-left: 4px solid #ffc107;
     font-family: monospace;
     font-size: 0.9rem;
     text-align: left;
   }
   */

   .filter-container {
     background: rgba(255,255,255,0.6);
     backdrop-filter: blur(8px);
     padding: 20px;
     border-radius: 20px;
     width: 90%;
     max-width: 700px;
     box-shadow: 0 8px 24px rgba(0,0,0,0.1);
     margin-bottom: 20px;
     text-align: center;
   }

   .filter-buttons {
     display: flex;
     justify-content: center;
     gap: 10px;
     flex-wrap: wrap;
   }

   .filter-btn {
     background: rgba(255, 255, 255, 0.5);
     border: 2px solid #6a82fb;
     color: #6a82fb;
     padding: 10px 20px;
     border-radius: 25px;
     font-weight: bold;
     cursor: pointer;
     transition: all 0.3s ease;
     font-size: 0.9rem;
   }

   .filter-btn:hover {
     background: rgba(106, 130, 251, 0.1);
     transform: translateY(-2px);
   }

   .filter-btn.active {
     background: #6a82fb;
     color: white;
     box-shadow: 0 4px 12px rgba(106, 130, 251, 0.3);
   }

   .filter-stats {
     margin-top: 15px;
     font-size: 0.9rem;
     color: #666;
     display: flex;
     justify-content: center;
     gap: 20px;
     flex-wrap: wrap;
   }

   .stat-item {
     background: rgba(255, 255, 255, 0.7);
     padding: 8px 15px;
     border-radius: 15px;
     font-weight: bold;
   }

   .stat-all { border-left: 4px solid #6a82fb; }
   .stat-pending { border-left: 4px solid #ffa500; }
   .stat-solved { border-left: 4px solid #38ef7d; }

   .complaint-list {
     background: rgba(255,255,255,0.5);
     backdrop-filter: blur(6px);
     border-radius: 16px;
     padding: 20px;
     width: 90%;
     max-width: 700px;
     box-shadow: 0 4px 12px rgba(0,0,0,0.1);
     animation: fadeIn 1s ease;
     margin-bottom: 20px;
   }

   .complaint-card {
     background: rgba(255,255,255,0.7);
     border-radius: 12px;
     padding: 20px;
     margin-bottom: 15px;
     border-left: 5px solid #6a82fb;
     box-shadow: 0 2px 8px rgba(0,0,0,0.1);
     transition: transform 0.2s ease;
     display: block;
   }

   .complaint-card.hidden {
     display: none;
   }

   .complaint-card:hover {
     transform: translateY(-2px);
     box-shadow: 0 4px 12px rgba(0,0,0,0.15);
   }

   .complaint-card.pending {
     border-left-color: #ffa500;
   }

   .complaint-card.solved {
     border-left-color: #38ef7d;
   }

   .complaint-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: 10px;
   }

   .complaint-id {
     font-weight: bold;
     color: #6a82fb;
     font-size: 1.1rem;
   }

   .status-badge {
     display: inline-block;
     padding: 4px 12px;
     border-radius: 20px;
     font-size: 0.9rem;
     font-weight: bold;
   }

   .status-pending {
     background: rgba(255, 165, 0, 0.2);
     color: #ff8c00;
   }

   .status-solved {
     background: rgba(56, 239, 125, 0.2);
     color: #11998e;
   }

   .complaint-title {
     font-weight: bold;
     font-size: 1.1rem;
     margin-bottom: 8px;
     color: #333;
   }

   .complaint-description {
     color: #666;
     margin-bottom: 10px;
     line-height: 1.5;
   }

   .complaint-meta {
     display: flex;
     justify-content: space-between;
     font-size: 0.9rem;
     color: #888;
     margin-top: 10px;
   }

   .no-complaints {
     text-align: center;
     color: #666;
     font-style: italic;
     padding: 40px;
   }

   .loading-message {
     color: #6a82fb;
     background: rgba(106, 130, 251, 0.1);
     padding: 20px;
     border-radius: 12px;
     text-align: center;
     border-left: 5px solid #6a82fb;
   }

   .error-message {
     color: #e74c3c;
     background: rgba(231, 76, 60, 0.1);
     padding: 20px;
     border-radius: 12px;
     text-align: center;
     border-left: 5px solid #e74c3c;
   }

   .refresh-btn {
     background: #6a82fb;
     color: white;
     padding: 10px 20px;
     border: none;
     border-radius: 25px;
     font-weight: bold;
     cursor: pointer;
     margin-top: 15px;
     transition: all 0.3s ease;
   }

   .refresh-btn:hover {
     background: #fc5c7d;
     transform: scale(1.05);
   }

   .refresh-btn:disabled {
     background: #ccc;
     transform: none;
     cursor: not-allowed;
   }

   .back-link {
     margin-top: 15px;
   }

   .back-link a {
     text-decoration: none;
     font-weight: bold;
     color: #0056b3;
     padding: 10px 20px;
     border-radius: 20px;
     background: rgba(255, 255, 255, 0.3);
     transition: all 0.3s ease;
   }

   .back-link a:hover {
     background: rgba(255, 255, 255, 0.6);
     text-decoration: none;
   }

   @keyframes fadeIn {
     from {opacity: 0;}
     to {opacity: 1;}
   }
 </style>
</head>
<body>
 <div class="header">üìÇ View Your Complaints</div>

 <div class="auto-load-container">
   <div class="student-info">
     <h3>Student Information</h3>
     <p id="studentInfo">Loading student information...</p>
     <button class="refresh-btn" id="refreshBtn" onclick="loadComplaints()">üîÑ Refresh Complaints</button>
   </div>
   
   <!-- DEBUG INFO CONTAINER - COMMENTED OUT
   <div class="debug-info" id="debugInfo">
     <h4>Debug Information:</h4>
     <p>Initializing...</p>
   </div>
   -->
 </div>

 <div class="filter-container">
   <h3>üìä Filter Complaints</h3>
   <div class="filter-buttons">
     <button class="filter-btn active" onclick="filterComplaints('all')">üîç All Complaints</button>
     <button class="filter-btn" onclick="filterComplaints('pending')">‚è≥ Pending</button>
     <button class="filter-btn" onclick="filterComplaints('solved')">‚úÖ Solved</button>
   </div>
   
   <div class="filter-stats" id="filterStats">
     <div class="stat-item stat-all">Total: <span id="totalCount">0</span></div>
     <div class="stat-item stat-pending">Pending: <span id="pendingCount">0</span></div>
     <div class="stat-item stat-solved">Solved: <span id="solvedCount">0</span></div>
   </div>
 </div>

 <div id="complaintsOutput" class="complaint-list"></div>

 <div class="back-link">
   <a href="dashb.html">‚Üê Back to Dashboard</a>
 </div>

 <script>
   let currentUser = null;
   // DEBUG VARIABLES - COMMENTED OUT
   // let debugLog = [];
   let allComplaints = [];
   let currentFilter = 'all';

   // DEBUG FUNCTION - COMMENTED OUT
   /*
   function addDebugInfo(message) {
     debugLog.push(`[${new Date().toLocaleTimeString()}] ${message}`);
     const debugElement = document.getElementById('debugInfo');
     debugElement.innerHTML = `
       <h4>Debug Information:</h4>
       ${debugLog.slice(-10).map(log => `<p>${log}</p>`).join('')}
     `;
   }
   */

   function updateStats() {
     const totalCount = allComplaints.length;
     const pendingCount = allComplaints.filter(c => c.status === 0).length;
     const solvedCount = allComplaints.filter(c => c.status === 1).length;

     document.getElementById('totalCount').textContent = totalCount;
     document.getElementById('pendingCount').textContent = pendingCount;
     document.getElementById('solvedCount').textContent = solvedCount;

     // DEBUG - COMMENTED OUT
     // addDebugInfo(`Stats updated - Total: ${totalCount}, Pending: ${pendingCount}, Solved: ${solvedCount}`);
   }

   function filterComplaints(filter) {
     currentFilter = filter;
     
     // Update active filter button
     document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
     event.target.classList.add('active');

     const complaintCards = document.querySelectorAll('.complaint-card');
     let visibleCount = 0;

     complaintCards.forEach(card => {
       const status = card.classList.contains('solved') ? 'solved' : 'pending';
       
       if (filter === 'all' || 
           (filter === 'pending' && status === 'pending') ||
           (filter === 'solved' && status === 'solved')) {
         card.classList.remove('hidden');
         visibleCount++;
       } else {
         card.classList.add('hidden');
       }
     });

     // DEBUG - COMMENTED OUT
     // addDebugInfo(`Filter applied: ${filter}, showing ${visibleCount} complaints`);

     // Show appropriate message if no complaints match filter
     const outputBox = document.getElementById('complaintsOutput');
     if (visibleCount === 0 && allComplaints.length > 0) {
       const filterMessage = filter === 'pending' ? 'pending' : filter === 'solved' ? 'solved' : '';
       outputBox.innerHTML += `
         <div class="no-complaints" id="filterMessage">
           <h3>üì≠ No ${filterMessage} Complaints</h3>
           <p>You don't have any ${filterMessage} complaints at the moment.</p>
         </div>
       `;
     } else {
       // Remove filter message if it exists
       const filterMessage = document.getElementById('filterMessage');
       if (filterMessage) filterMessage.remove();
     }
   }

   document.addEventListener('DOMContentLoaded', () => {
     // DEBUG - COMMENTED OUT
     // addDebugInfo('Page loaded, checking session...');
     
     const sessionData = localStorage.getItem('userSession') || sessionStorage.getItem('userSession');
     // DEBUG - COMMENTED OUT
     // addDebugInfo(`Session data found: ${sessionData ? 'Yes' : 'No'}`);

     if (!sessionData) {
       // DEBUG - COMMENTED OUT
       // addDebugInfo('No session data found, would redirect to login');
       // For demo purposes, create mock user data
       currentUser = {
         name: 'Demo User',
         studentId: '12345',
         email: 'demo@university.edu'
       };
       // DEBUG - COMMENTED OUT
       // addDebugInfo('Using demo user data for testing');
     } else {
       try {
         currentUser = JSON.parse(sessionData);
         // DEBUG - COMMENTED OUT
         // addDebugInfo(`User data parsed: ID=${currentUser.studentId}`);
       } catch (e) {
         // DEBUG - COMMENTED OUT
         // addDebugInfo(`Error parsing session data: ${e.message}`);
         return;
       }
     }

     // Show student info
     document.getElementById('studentInfo').innerHTML = `
       <strong>Name:</strong> ${currentUser.name}<br>
       <strong>ID:</strong> ${currentUser.studentId}<br>
       <strong>Email:</strong> ${currentUser.email}
     `;
     
     // DEBUG - COMMENTED OUT
     // addDebugInfo('Student info displayed, loading complaints...');
     loadComplaints();
   });

   // Function to load complaints
   async function loadComplaints() {
     const outputBox = document.getElementById('complaintsOutput');
     const refreshBtn = document.getElementById('refreshBtn');

     if (!currentUser || !currentUser.studentId) {
       // DEBUG - COMMENTED OUT
       // addDebugInfo('ERROR: No current user or student ID');
       outputBox.innerHTML = '<div class="error-message">No user session found</div>';
       return;
     }

     try {
       // Show loading state
       refreshBtn.disabled = true;
       refreshBtn.textContent = 'üîÑ Loading...';
       
       outputBox.innerHTML = '<div class="loading-message">üîç Loading your complaints...</div>';
       // DEBUG - COMMENTED OUT
       // addDebugInfo(`Making API request to: http://localhost:3000/api/complaints/${currentUser.studentId}`);

       // Fetch complaints from backend
       const response = await fetch(`http://localhost:3000/api/complaints/${currentUser.studentId}`);
       
       // DEBUG - COMMENTED OUT
       // addDebugInfo(`API response status: ${response.status} ${response.statusText}`);

       if (!response.ok) {
         const errorText = await response.text();
         // DEBUG - COMMENTED OUT
         // addDebugInfo(`API Error Response: ${errorText}`);
         throw new Error(`Failed to fetch complaints: ${response.status}`);
       }

       const data = await response.json();
       // DEBUG - COMMENTED OUT
       // addDebugInfo(`API response received: ${JSON.stringify(data)}`);
       
       allComplaints = data.complaints || [];
       // DEBUG - COMMENTED OUT
       // addDebugInfo(`Number of complaints found: ${allComplaints.length}`);

       // Update statistics
       updateStats();

       if (allComplaints.length === 0) {
         outputBox.innerHTML = `
           <div class="no-complaints">
             <h3>üì≠ No Complaints Found</h3>
             <p>You haven't submitted any complaints yet.</p>
             <p>If you have any issues, feel free to <a href="/complaints" style="color: #6a82fb;">submit a complaint</a>.</p>
           </div>
         `;
         // DEBUG - COMMENTED OUT
         // addDebugInfo('Displayed no complaints message');
       } else {
         // Display complaints
         const complaintsHtml = allComplaints.map(complaint => {
           const complaintDate = new Date(complaint.time).toLocaleDateString();
           const statusText = complaint.status === 1 ? 'solved' : 'pending';

           return `
             <div class="complaint-card ${statusText}">
               <div class="complaint-header">
                 <span class="complaint-id">#${complaint.complaint_id}</span>
                 <span class="status-badge status-${statusText}">
                   ${(statusText).toUpperCase()}
                 </span>
               </div>
               <div class="complaint-title">${complaint.title}</div>
               
               <div class="complaint-description">${complaint.description}</div>

               ${complaint.status === 1 && complaint.resolution ? `
                 <div style="background: rgba(56, 239, 125, 0.1); padding: 10px; border-radius: 8px; margin-top: 10px;">
                   <strong>Resolution:</strong> ${complaint.resolution}
                 </div>
               ` : ''}
               
               <div class="complaint-meta">
                 <span>Submitted: ${complaintDate}</span>
                 <span>Student ID: ${complaint.student_id}</span>
               </div>
             </div>
           `;
         }).join('');
         
         outputBox.innerHTML = complaintsHtml;
         // DEBUG - COMMENTED OUT
         // addDebugInfo(`Displayed ${allComplaints.length} complaints`);

         // Apply current filter
         setTimeout(() => {
           const activeFilterBtn = document.querySelector('.filter-btn.active');
           if (activeFilterBtn) {
             const filterType = activeFilterBtn.textContent.includes('All') ? 'all' :
                               activeFilterBtn.textContent.includes('Pending') ? 'pending' : 'solved';
             filterComplaints(filterType);
           }
         }, 100);
       }

     } catch (error) {
       console.error('Error loading complaints:', error);
       // DEBUG - COMMENTED OUT
       // addDebugInfo(`ERROR: ${error.message}`);
       outputBox.innerHTML = `
         <div class="error-message">
           <h3>‚ùå Error Loading Complaints</h3>
           <p>Failed to load your complaints: ${error.message}</p>
           <p>Please check the console for more details.</p>
         </div>
       `;
     } finally {
       // Reset button
       refreshBtn.disabled = false;
       refreshBtn.textContent = 'üîÑ Refresh Complaints';
     }
   }
 </script>
</body>
</html>